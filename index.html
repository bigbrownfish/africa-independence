<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Независимость стран Африки</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #e0f7fa; font-family: sans-serif; overflow: hidden; touch-action: none; }
        #map-container { width: 100vw; height: 100vh; display: block; }
        
        .country { stroke: #333; stroke-width: 0.5px; transition: opacity 0.2s; cursor: pointer; }
        .country:hover { opacity: 0.7; }
        .island-marker { stroke: #333; stroke-width: 1px; cursor: pointer; transition: opacity 0.2s; }
        .island-marker:hover { opacity: 0.7; }
        
        .year-label { font-size: 8px; font-weight: bold; fill: #000; text-anchor: middle; pointer-events: none; text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white; }
        .island-label { font-size: 8px; font-weight: bold; fill: #000; text-anchor: start; pointer-events: none; text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white; }
        
        #tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            font-size: 14px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
            max-width: 250px;
            z-index: 10;
        }
        .tooltip-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #2c3e50; }
        .tooltip-row { margin-bottom: 3px; }

        #legend {
            position: absolute;
            bottom: 20px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #999;
            border-radius: 6px;
            font-size: 12px;
            max-height: 40vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
            z-index: 5;
            width: 200px;
            /* Включаем аппаратное ускорение для плавности */
            will-change: left, top;
        }
        
        #legend-drag-handle {
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            cursor: grab;
            background: #e0e0e0;
            border-bottom: 1px solid #ccc;
            border-radius: 6px 6px 0 0;
            padding: 8px;
            user-select: none;
            touch-action: none;
        }
        #legend-drag-handle:active { cursor: grabbing; background: #d0d0d0; }
        
        #legend-content {
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; 
        }

        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-color { width: 16px; height: 16px; margin-right: 8px; border: 1px solid #666; border-radius: 2px; flex-shrink: 0; }
        .legend-pattern { width: 16px; height: 16px; margin-right: 8px; border: 1px solid #666; border-radius: 2px; flex-shrink: 0; background: repeating-linear-gradient(45deg, #ccc, #ccc 4px, #fff 4px, #fff 8px); }
    </style>
</head>
<body>

<div id="tooltip"></div>

<div id="legend">
    <div id="legend-drag-handle">≡ Условные обозначения</div>
    <div id="legend-content">
        <div id="legend-items"></div>
    </div>
</div>

<svg id="map-container"></svg>

<script>
const metropoleColors = {
    "Франция": "#4287f5",
    "Великобритания": "#f54242",
    "Испания": "#f5d142",
    "Италия": "#9e42f5",
    "Португалия": "#42f563",
    "Германия": "#f58742",
    "Бельгия": "#8b5a2b",
    "США": "#ff99cc",
    "Нидерланды": "#42d4f5",
    "ЮАР": "#808080",
    "Египет": "#1a1a1a",
    "Судан": "#b30000",
    "Дания": "#ffd700",
    "Швеция": "#a1caf1",
    "Никогда не была колонизирована": "#ffffff"
};

const countryData = {
    "ESH": { name: "За́падная Саха́ра", capital: "Эль-Аю́н (заявленная), Тифарити (фактическая)", metro: ["Испания"], metro_text: "Испания (до 1976)", year: "1976" },
    "MAR": { name: "Маро́кко", capital: "Раба́т", metro: ["Франция", "Испания"], metro_text: "Франция (1912-1956), Испания (1912-1956)", year: "1956" },
    "DZA": { name: "Алжи́р", capital: "Алжи́р", metro: ["Франция"], metro_text: "Франция (1830-1962)", year: "1962" },
    "LBY": { name: "Ли́вия", capital: "Три́поли", metro: ["Италия", "Великобритания", "Франция"], metro_text: "Италия (1911-1947), Великобритания (1947-1951), Франция (1947-1951)", year: "1951" },
    "EGY": { name: "Еги́пет", capital: "Каи́р", metro: ["Великобритания"], metro_text: "Великобритания (1882-1922)", year: "1922" },
    "TUN": { name: "Туни́с", capital: "Туни́с", metro: ["Франция"], metro_text: "Франция (1881-1956)", year: "1956" },
    "SDN": { name: "Суда́н", capital: "Харту́м", metro: ["Великобритания", "Египет"], metro_text: "Великобритания (1899-1956), Египет (1899-1956)", year: "1956" },
    "MRT": { name: "Маврита́ния", capital: "Нуакшо́т", metro: ["Франция"], metro_text: "Франция (1814-1960)", year: "1960" },
    "SEN": { name: "Сенега́л", capital: "Дака́р", metro: ["Франция"], metro_text: "Франция (1634-1960)", year: "1960" },
    "GMB": { name: "Га́мбия", capital: "Банжу́л", metro: ["Великобритания"], metro_text: "Великобритания (1661-1965)", year: "1965" },
    "GNB": { name: "Гвине́я-Биса́у", capital: "Биса́у", metro: ["Португалия"], metro_text: "Португалия (до 1974/1975)", year: "1973 (провозглашена), 1974 (признана)" },
    "GIN": { name: "Гвине́я", capital: "Конакри́", metro: ["Франция"], metro_text: "Франция (1898-1958)", year: "1958" },
    "SLE": { name: "Сье́рра-Лео́не", capital: "Фри́таун", metro: ["Великобритания"], metro_text: "Великобритания (1787-1961)", year: "1961" },
    "LBR": { name: "Либе́рия", capital: "Монро́вия", metro: ["США"], metro_text: "США (1822-1847)", year: "1847" },
    "CIV": { name: "Кот-д’Ивуа́р", capital: "Ямусу́кро", metro: ["Франция"], metro_text: "Франция (1845-1960)", year: "1960" },
    "GHA": { name: "Га́на", capital: "Аккра́", metro: ["Великобритания", "Дания", "Швеция"], metro_text: "Великобритания (до 1957), Дания (до 1850), Швеция (до 1657)", year: "1957" },
    "TGO": { name: "То́го", capital: "То́го", metro: ["Германия", "Франция"], metro_text: "Германия (1884-1914), Франция (1916-1960)", year: "1960" },
    "BEN": { name: "Бени́н", capital: "По́рто-Но́во (де-факто Котону́)", metro: ["Франция"], metro_text: "Франция (1894-1960)", year: "1960" },
    "NGA": { name: "Ниге́рия", capital: "Абу́джа", metro: ["Великобритания"], metro_text: "Великобритания (1861-1960)", year: "1960" },
    "NER": { name: "Ни́гер", capital: "Ниаме́й", metro: ["Франция"], metro_text: "Франция (до 1960)", year: "1960" },
    "BFA": { name: "Буркина́-Фасо́", capital: "Уагаду́гу", metro: ["Франция"], metro_text: "Франция (до 1960)", year: "1960" },
    "MLI": { name: "Мали́", capital: "Бамако́", metro: ["Франция"], metro_text: "Франция (1880-1960)", year: "1960" },
    "TCD": { name: "Чад", capital: "Нджаме́на", metro: ["Франция"], metro_text: "Франция (1900-1960)", year: "1960" },
    "CMR": { name: "Камеру́н", capital: "Яунде", metro: ["Германия", "Франция", "Великобритания"], metro_text: "Германия (1884-1916), Франция (1916-1960), Великобритания (1916-1961)", year: "1960" },
    "GNQ": { name: "Экваториа́льная Гвине́я", capital: "Сьюда́д-де-ла-Пас", metro: ["Испания"], metro_text: "Испания (1858-1968)", year: "1968" },
    "GAB": { name: "Габо́н", capital: "Либреви́ль", metro: ["Франция"], metro_text: "Франция (1839-1960)", year: "1960" },
    "COG": { name: "Респу́блика Ко́нго", capital: "Браззави́ль", metro: ["Франция"], metro_text: "Франция (1880-1960)", year: "1960" },
    "AGO": { name: "Анго́ла", capital: "Луа́нда", metro: ["Португалия"], metro_text: "Португалия (1575-1975)", year: "1975" },
    "COD": { name: "Демократи́ческая Респу́блика Ко́нго, capital: "Кинша́са", metro: ["Бельгия"], metro_text: "Бельгия (1885/1908-1960)", year: "1960" },
    "CAF": { name: "Центральноафрика́нская Респу́блика", capital: "Банги́", metro: ["Франция"], metro_text: "Франция (до 1960)", year: "1960" },
    "SSD": { name: "Южный Суда́н", capital: "Джу́ба", metro: ["Великобритания", "Судан"], metro_text: "Великобритания (1899-1956), Судан (1956-2011)", year: "2011" },
    "ETH": { name: "Эфио́пия", capital: "Адди́с-Абе́ба", metro: ["Никогда не была колонизирована"], metro_text: "Никогда не была колонизирована (Италия 1936-1941)", year: "Древнее гос-во" },
    "ERI": { name: "Эритре́я", capital: "Асмэ́ра", metro: ["Италия", "Великобритания", "Эфиопия"], metro_text: "Италия (1889-1941), Великобритания (1941-1952), Эфиопия (1952-1993)", year: "1993" },
    "DJI": { name: "Джибу́ти", capital: "Джибу́ти", metro: ["Франция"], metro_text: "Франция (1861-1977)", year: "1977" },
    "SOM": { name: "Сомали́", capital: "Могади́шо", metro: ["Великобритания", "Италия"], metro_text: "Великобритания (до 1960), Италия (до 1960)", year: "1960" },
    "SOL": { name: "Сомалиле́нд", capital: "Харге́йса", metro: ["Великобритания"], metro_text: "Великобритания (до 1960), в составе Сомали (1960-1991)", year: "1991" },
    "KEN": { name: "Ке́ния", capital: "Найро́би", metro: ["Великобритания"], metro_text: "Великобритания (1895-1963)", year: "1963" },
    "UGA": { name: "Уга́нда", capital: "Кампа́ла", metro: ["Великобритания"], metro_text: "Великобритания (1894-1962)", year: "1962" },
    "RWA": { name: "Руа́нда", capital: "Кига́ли", metro: ["Германия", "Бельгия"], metro_text: "Германия (1899-1916), Бельгия (1916-1962)", year: "1962" },
    "BDI": { name: "Буру́нди", capital: "Гите́га", metro: ["Германия", "Бельгия"], metro_text: "Германия (1899-1916), Бельгия (1916-1962)", year: "1962" },
    "TZA": { name: "Танза́ния", capital: "Додо́ма", metro: ["Германия", "Великобритания"], metro_text: "Германия (1885-1919), Великобритания (1919-1961)", year: "1961" },
    "MOZ": { name: "Мозамби́к", capital: "Мапу́ту", metro: ["Португалия"], metro_text: "Португалия (до 1975)", year: "1975" },
    "MWI": { name: "Мала́ви", capital: "Лило́нгве", metro: ["Великобритания"], metro_text: "Великобритания (1891-1964)", year: "1964" },
    "ZMB": { name: "За́мбия", capital: "Луса́ка", metro: ["Великобритания"], metro_text: "Великобритания (до 1964)", year: "1964" },
    "ZWE": { name: "Зимба́бве", capital: "Хара́ре", metro: ["Великобритания"], metro_text: "Великобритания (до 1980)", year: "1980" },
    "MDG": { name: "Мадагаска́р", capital: "Антананари́ву", metro: ["Франция"], metro_text: "Франция (1885-1960)", year: "1960" },
    "NAM": { name: "Нами́бия", capital: "Ви́ндхук", metro: ["Германия", "ЮАР"], metro_text: "Германия (1884-1915), ЮАР (1915-1990)", year: "1990" },
    "BWA": { name: "Ботсва́на", capital: "Габоро́не", metro: ["Великобритания"], metro_text: "Великобритания (1885-1966)", year: "1966" },
    "ZAF": { name: "Южно-Африка́нская Респу́блика", capital: "Кейпта́ун (законодательная); Прето́рия (административная); Блу́мфонтейн (судебная)", metro: ["Нидерланды", "Великобритания"], metro_text: "Нидерланды (1652-1795), Великобритания (1795-1910), Доминион (1910-1961)", year: "1961" },
    "SWZ": { name: "Эсвати́ни", capital: "Мбаба́не (официальная), Лобамба (королевская и парламентская)", metro: ["Великобритания"], metro_text: "Великобритания (до 1968)", year: "1968" },
    "LSO": { name: "Лесо́то", capital: "Масе́ру", metro: ["Великобритания"], metro_text: "Великобритания (1868-1966)", year: "1966" }
};

const islandNations = [
    { id: "CPV", coords: [-24.01, 16.00], info: { name: "Ка́бо-Ве́рде", capital: "Пра́я", metro: ["Португалия"], metro_text: "Португалия (до 1975)", year: "1975" } },
    { id: "STP", coords: [6.61, 0.25], info: { name: "Сан-Томе и Принси́пи", capital: "Сан-Томе", metro: ["Португалия"], metro_text: "Португалия (до 1975)", year: "1975" } },
    { id: "COM", coords: [43.33, -11.64], info: { name: "Комо́ры", capital: "Моро́ни", metro: ["Франция"], metro_text: "Франция (1886-1975)", year: "1975" } },
    { id: "SYC", coords: [55.49, -4.68], info: { name: "Сейше́льские острова", capital: "Викто́рия", metro: ["Франция", "Великобритания"], metro_text: "Франция (1750-1814), Великобритания (1814-1976)", year: "1976" } },
    { id: "MUS", coords: [57.55, -20.35], info: { name: "Маври́кий", capital: "Порт-Луи", metro: ["Франция", "Великобритания"], metro_text: "Франция (1715-1810), Великобритания (1810-1968)", year: "1968" } }
];

// Заполнение легенды
const legendContainer = d3.select("#legend-items");
Object.entries(metropoleColors).forEach(([metro, color]) => {
    const item = legendContainer.append("div").attr("class", "legend-item");
    item.append("div").attr("class", "legend-color").style("background-color", color);
    item.append("div").text(metro);
});
const mixedItem = legendContainer.append("div").attr("class", "legend-item").style("margin-top", "8px");
mixedItem.append("div").attr("class", "legend-pattern");
mixedItem.append("div").style("font-style", "italic").style("font-size", "11px").text("Штриховка: Несколько метрополий");

// --- ПЛАВНОЕ ПЕРЕТАСКИВАНИЕ НА POINTER EVENTS ---
const legendEl = document.getElementById("legend");
const dragHandle = document.getElementById("legend-drag-handle");
let isDragging = false;
let startX, startY, initialLeft, initialTop;

dragHandle.addEventListener("pointerdown", (e) => {
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    
    // Фиксируем координаты (сбрасываем bottom)
    const rect = legendEl.getBoundingClientRect();
    legendEl.style.bottom = "auto";
    legendEl.style.right = "auto";
    initialLeft = rect.left;
    initialTop = rect.top;
    legendEl.style.left = initialLeft + "px";
    legendEl.style.top = initialTop + "px";
    
    dragHandle.setPointerCapture(e.pointerId); // Удерживаем фокус на перетаскивании
});

dragHandle.addEventListener("pointermove", (e) => {
    if (!isDragging) return;
    
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    let newX = initialLeft + dx;
    let newY = initialTop + dy;
    
    // Границы экрана
    newX = Math.max(0, Math.min(window.innerWidth - legendEl.offsetWidth, newX));
    newY = Math.max(0, Math.min(window.innerHeight - legendEl.offsetHeight, newY));

    legendEl.style.left = newX + "px";
    legendEl.style.top = newY + "px";
});

dragHandle.addEventListener("pointerup", (e) => {
    isDragging = false;
    dragHandle.releasePointerCapture(e.pointerId);
});
// --------------------------------------------------

const svg = d3.select("#map-container");
const defs = svg.append("defs");
const mapGroup = svg.append("g"); 

function getFillStyle(metros, id) {
    if (metros.length === 1) return metropoleColors[metros[0]] || "#ccc";
    const patternId = "pattern-" + id;
    if (defs.select(`#${patternId}`).empty()) {
        const pattern = defs.append("pattern")
            .attr("id", patternId)
            .attr("patternUnits", "userSpaceOnUse")
            .attr("width", metros.length * 6)
            .attr("height", metros.length * 6)
            .attr("patternTransform", "rotate(45)");
        metros.forEach((metro, index) => {
            pattern.append("rect")
                .attr("x", index * 6)
                .attr("y", 0)
                .attr("width", 6)
                .attr("height", metros.length * 6)
                .attr("fill", metropoleColors[metro] || "#ccc");
        });
    }
    return `url(#pattern-${id})`;
}

const projection = d3.geoMercator();
const path = d3.geoPath().projection(projection);
const tooltip = d3.select("#tooltip");

svg.on("click", function(event) {
    if (event.target.tagName === "svg") hideTooltip();
});

function showTooltip(event, info) {
    tooltip.transition().duration(200).style("opacity", .95);
    let pointerEvent = event;
    if (event.touches && event.touches.length > 0) pointerEvent = event.touches[0];

    let xPos = pointerEvent.pageX + 15;
    let yPos = pointerEvent.pageY - 28;
    
    if (xPos + 250 > window.innerWidth) xPos = window.innerWidth - 260;
    
    tooltip.html(`
        <div class="tooltip-title">${info.name}</div>
        <div class="tooltip-row"><b>Столица:</b> ${info.capital}</div>
        <div class="tooltip-row"><b>Год независимости:</b> ${info.year}</div>
        <div class="tooltip-row"><b>Метрополия:</b> ${info.metro_text}</div>
    `)
    .style("left", Math.max(10, xPos) + "px")
    .style("top", Math.max(10, yPos) + "px");
}

function hideTooltip() {
    tooltip.transition().duration(200).style("opacity", 0);
}

function resolveGeoId(properties) {
    const idCandidates = [properties.ADM0_A3, properties.ISO_A3, properties.GU_A3, properties.SU_A3];
    for (let id of idCandidates) {
        if (!id || id === "-99") continue;
        if (countryData[id]) return id;
        if (id === "SAH") return "ESH"; 
        if (id === "SDS") return "SSD"; 
    }
    const name = properties.NAME || properties.ADMIN;
    if (name === "Madagascar") return "MDG";
    if (name === "Western Sahara" || name === "W. Sahara") return "ESH";
    if (name === "Somaliland") return "SOL";
    return null;
}

const zoom = d3.zoom()
    .scaleExtent([1, 8]) 
    .on("zoom", function(event) {
        mapGroup.attr("transform", event.transform);
        mapGroup.selectAll(".country").style("stroke-width", 0.5 / event.transform.k + "px");
        mapGroup.selectAll(".island-marker").style("stroke-width", 1 / event.transform.k + "px");
        mapGroup.selectAll("text").style("font-size", (8 / Math.max(1, event.transform.k * 0.5)) + "px");
        hideTooltip();
    });

svg.call(zoom);

// Загружаем карту с параметром, чтобы обойти жесткое кэширование внутри скрипта
d3.json("ne_110m_admin_0_countries.geojson?v=2").then(world => {
    
    const africa = world.features.filter(d => resolveGeoId(d.properties) !== null);
    
    projection.fitExtent([[30, 30], [window.innerWidth - 30, window.innerHeight - 30]], {type: "FeatureCollection", features: africa});

    mapGroup.selectAll("path")
        .data(africa)
        .enter().append("path")
        .attr("d", path)
        .attr("class", "country")
        .attr("fill", d => {
            const geoId = resolveGeoId(d.properties);
            return getFillStyle(countryData[geoId].metro, geoId);
        })
        .on("click", (event, d) => {
            event.stopPropagation(); 
            showTooltip(event, countryData[resolveGeoId(d.properties)]);
        });

    mapGroup.selectAll(".year-label")
        .data(africa)
        .enter().append("text")
        .attr("class", "year-label")
        .attr("transform", function(d) {
            const centroid = path.centroid(d);
            return (!isNaN(centroid[0]) && !isNaN(centroid[1])) ? `translate(${centroid[0]}, ${centroid[1]})` : "translate(-1000,-1000)"; 
        })
        .text(d => {
            const geoId = resolveGeoId(d.properties);
            return countryData[geoId].year.split('/')[0].split(' ')[0];
        });

    const islands = mapGroup.selectAll(".island-group")
        .data(islandNations)
        .enter().append("g")
        .attr("transform", d => `translate(${projection(d.coords)[0]}, ${projection(d.coords)[1]})`);

    islands.append("circle")
        .attr("class", "island-marker")
        .attr("r", 5)
        .attr("fill", d => getFillStyle(d.info.metro, d.id))
        .on("click", (event, d) => {
            event.stopPropagation();
            showTooltip(event, d.info);
        });

    islands.append("text")
        .attr("class", "island-label")
        .attr("dx", 8)
        .attr("dy", 3)
        .text(d => d.info.year.split('/')[0].split(' ')[0]);
});

window.addEventListener('resize', () => {
    svg.attr("width", window.innerWidth).attr("height", window.innerHeight);
});
</script>
</body>
</html>

